<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}">DMV Rules Engine - JShell REPL</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-dark.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background-color: #2d2d30;
            padding: 10px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #569cd6;
            font-size: 18px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4ec9b0;
        }

        .status-indicator.disconnected {
            background-color: #f44747;
        }

        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .output-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: #1e1e1e;
        }

        .output-line {
            margin-bottom: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output-line.input {
            color: #569cd6;
        }

        .output-line.input::before {
            content: "dmv-jshell> ";
            color: #4ec9b0;
        }

        .output-line.result {
            color: #ce9178;
        }

        .output-line.result::before {
            content: "=> ";
            color: #4ec9b0;
        }

        .output-line.error {
            color: #f44747;
        }

        .output-line.error::before {
            content: "Error: ";
            color: #f44747;
        }

        .input-container {
            background-color: #2d2d30;
            border-top: 1px solid #3e3e42;
            padding: 15px 20px;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .prompt {
            color: #4ec9b0;
            font-weight: bold;
        }

        .input-field {
            flex: 1;
            background-color: #3c3c3c;
            border: 1px solid #5a5a5a;
            color: #d4d4d4;
            padding: 8px 12px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }

        .input-field:focus {
            outline: none;
            border-color: #007acc;
        }

        .execute-btn {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .execute-btn:hover {
            background-color: #1177bb;
        }

        .execute-btn:disabled {
            background-color: #5a5a5a;
            cursor: not-allowed;
        }

        .toolbar {
            background-color: #2d2d30;
            padding: 8px 20px;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            gap: 10px;
        }

        .toolbar button {
            background-color: #3c3c3c;
            color: #d4d4d4;
            border: 1px solid #5a5a5a;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .toolbar button:hover {
            background-color: #4a4a4a;
        }

        .help-panel {
            background-color: #252526;
            border-left: 1px solid #3e3e42;
            width: 300px;
            padding: 20px;
            overflow-y: auto;
            display: none;
        }

        .help-panel.visible {
            display: block;
        }

        .help-section {
            margin-bottom: 20px;
        }

        .help-section h3 {
            color: #569cd6;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .help-section ul {
            list-style: none;
            padding-left: 0;
        }

        .help-section li {
            margin-bottom: 5px;
            font-size: 12px;
            color: #cccccc;
        }

        .help-section code {
            background-color: #3c3c3c;
            padding: 2px 4px;
            border-radius: 2px;
            color: #ce9178;
        }

        .content-wrapper {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>DMV Rules Engine - Interactive JShell REPL</h1>
        <div class="status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">Connecting...</span>
        </div>
    </div>

    <div class="toolbar">
        <button onclick="clearOutput()">Clear</button>
        <button onclick="showHistory()">History</button>
        <button onclick="toggleHelp()">Help</button>
        <button onclick="insertSample('sampleAdult')">Sample Adult</button>
        <button onclick="insertSample('sampleMinor')">Sample Minor</button>
        <button onclick="insertSample('sampleExpired')">Sample Expired</button>
    </div>

    <div class="content-wrapper">
        <div class="main-container">
            <div class="output-container" id="outputContainer">
                <div class="output-line">Welcome to DMV Rules Engine JShell REPL!</div>
                <div class="output-line">Type Java code to execute. Use Ctrl+Enter to execute multi-line code.</div>
                <div class="output-line">Pre-loaded variables: sampleAdult, sampleMinor, sampleExpired, sampleWithViolations</div>
                <div class="output-line">---</div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <span class="prompt">dmv-jshell></span>
                    <input type="text" class="input-field" id="inputField" placeholder="Enter Java code..." autocomplete="off">
                    <button class="execute-btn" id="executeBtn" onclick="executeCode()">Execute</button>
                </div>
            </div>
        </div>

        <div class="help-panel" id="helpPanel">
            <div class="help-section">
                <h3>Quick Commands</h3>
                <ul>
                    <li><code>sampleAdult</code> - Valid adult renewal request</li>
                    <li><code>sampleMinor</code> - Minor renewal request</li>
                    <li><code>sampleExpired</code> - Expired license renewal</li>
                    <li><code>sampleWithViolations</code> - Request with violations</li>
                </ul>
            </div>

            <div class="help-section">
                <h3>Sample Operations</h3>
                <ul>
                    <li><code>sampleAdult.getPersonalInfo()</code></li>
                    <li><code>sampleAdult.getCurrentLicense().isExpired()</code></li>
                    <li><code>sampleAdult.hasOutstandingViolations()</code></li>
                </ul>
            </div>

            <div class="help-section">
                <h3>JSON Conversion</h3>
                <ul>
                    <li><code>factToJson(sampleAdult)</code></li>
                    <li><code>jsonToFact(jsonString)</code></li>
                </ul>
            </div>

            <div class="help-section">
                <h3>Keyboard Shortcuts</h3>
                <ul>
                    <li><code>Enter</code> - Execute code</li>
                    <li><code>Ctrl+Enter</code> - Execute multi-line</li>
                    <li><code>Up/Down</code> - Command history</li>
                    <li><code>Tab</code> - Auto-complete (coming soon)</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let websocket;
        let commandHistory = [];
        let historyIndex = -1;
        let isConnected = false;

        // Initialize WebSocket connection
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/jshell`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function(event) {
                console.log('WebSocket connected');
                isConnected = true;
                updateStatus('Connected', true);
                document.getElementById('executeBtn').disabled = false;
            };
            
            websocket.onmessage = function(event) {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };
            
            websocket.onclose = function(event) {
                console.log('WebSocket disconnected');
                isConnected = false;
                updateStatus('Disconnected', false);
                document.getElementById('executeBtn').disabled = true;
                
                // Attempt to reconnect after 3 seconds
                setTimeout(initWebSocket, 3000);
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus('Error', false);
            };
        }

        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'welcome':
                    addOutputLine(`Session created: ${message.sessionId}`, 'info');
                    break;
                    
                case 'execution_result':
                    handleExecutionResult(message);
                    break;
                    
                case 'completion_result':
                    handleCompletionResult(message);
                    break;
                    
                case 'history_result':
                    handleHistoryResult(message);
                    break;
                    
                case 'error':
                    addOutputLine(message.message, 'error');
                    break;
                    
                default:
                    console.log('Unknown message type:', message.type);
            }
        }

        function handleExecutionResult(result) {
            if (result.success) {
                if (result.output && result.output.trim()) {
                    addOutputLine(result.output.trim(), 'output');
                }
                if (result.resultValue && result.resultValue.trim()) {
                    addOutputLine(result.resultValue.trim(), 'result');
                }
            } else {
                if (result.errorOutput && result.errorOutput.trim()) {
                    addOutputLine(result.errorOutput.trim(), 'error');
                }
                if (result.diagnostics && result.diagnostics.length > 0) {
                    result.diagnostics.forEach(diagnostic => {
                        addOutputLine(diagnostic, 'error');
                    });
                }
            }
        }

        function executeCode() {
            const inputField = document.getElementById('inputField');
            const code = inputField.value.trim();
            
            if (!code || !isConnected) {
                return;
            }
            
            // Add to command history
            commandHistory.push(code);
            historyIndex = commandHistory.length;
            
            // Display input in output
            addOutputLine(code, 'input');
            
            // Send to WebSocket
            websocket.send(JSON.stringify({
                type: 'execute',
                code: code
            }));
            
            // Clear input field
            inputField.value = '';
        }

        function addOutputLine(text, type = 'output') {
            const outputContainer = document.getElementById('outputContainer');
            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            line.textContent = text;
            outputContainer.appendChild(line);
            outputContainer.scrollTop = outputContainer.scrollHeight;
        }

        function clearOutput() {
            const outputContainer = document.getElementById('outputContainer');
            outputContainer.innerHTML = '';
            addOutputLine('Output cleared.', 'info');
        }

        function showHistory() {
            if (commandHistory.length === 0) {
                addOutputLine('No command history available.', 'info');
                return;
            }
            
            addOutputLine('Command History:', 'info');
            commandHistory.forEach((cmd, index) => {
                addOutputLine(`${index + 1}: ${cmd}`, 'info');
            });
        }

        function toggleHelp() {
            const helpPanel = document.getElementById('helpPanel');
            helpPanel.classList.toggle('visible');
        }

        function insertSample(sampleName) {
            const inputField = document.getElementById('inputField');
            inputField.value = sampleName;
            inputField.focus();
        }

        function updateStatus(text, connected) {
            const statusText = document.getElementById('statusText');
            const statusIndicator = document.getElementById('statusIndicator');
            
            statusText.textContent = text;
            
            if (connected) {
                statusIndicator.classList.remove('disconnected');
            } else {
                statusIndicator.classList.add('disconnected');
            }
        }

        // Event listeners
        document.getElementById('inputField').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                if (event.ctrlKey) {
                    // Multi-line mode - add newline
                    this.value += '\n';
                } else {
                    executeCode();
                }
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                if (historyIndex > 0) {
                    historyIndex--;
                    this.value = commandHistory[historyIndex];
                }
            } else if (event.key === 'ArrowDown') {
                event.preventDefault();
                if (historyIndex < commandHistory.length - 1) {
                    historyIndex++;
                    this.value = commandHistory[historyIndex];
                } else {
                    historyIndex = commandHistory.length;
                    this.value = '';
                }
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initWebSocket();
            document.getElementById('inputField').focus();
        });
    </script>
</body>
</html>