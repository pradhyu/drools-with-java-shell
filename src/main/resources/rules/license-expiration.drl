package com.dmv.rules

import com.dmv.model.LicenseRenewalRequest
import com.dmv.model.RenewalDecision
import com.dmv.model.DecisionType
import com.dmv.model.LicenseStatus

rule "License Status - Suspended or Revoked"
    salience 100
    when
        $request : LicenseRenewalRequest( 
            currentLicense.status == LicenseStatus.SUSPENDED || 
            currentLicense.status == LicenseStatus.REVOKED 
        )
        not RenewalDecision()
    then
        RenewalDecision decision = new RenewalDecision(DecisionType.REJECTED);
        decision.addReason("License status is " + $request.getCurrentLicense().getStatus());
        decision.addRequirement("Resolve license status issues before renewal");
        insert(decision);
end

rule "License Expiration - Expired More Than 6 Months Requires Test"
    salience 90
    when
        $request : LicenseRenewalRequest( 
            currentLicense.expired == true,
            currentLicense.monthsSinceExpiration > 6
        )
        $decision : RenewalDecision( decision == DecisionType.APPROVED )
    then
        $decision.setDecision(DecisionType.REQUIRES_ACTION);
        $decision.addRequirement("Driving test required - license expired more than 6 months ago");
        $decision.addReason("License has been expired for " + $request.getCurrentLicense().getMonthsSinceExpiration() + " months");
        update($decision);
end

rule "License Expiration - Recently Expired Allowed"
    salience 80
    when
        $request : LicenseRenewalRequest( 
            currentLicense.expired == true,
            currentLicense.monthsSinceExpiration <= 6
        )
        $decision : RenewalDecision( decision == DecisionType.APPROVED )
    then
        $decision.addReason("License recently expired (" + $request.getCurrentLicense().getMonthsSinceExpiration() + " months) - renewal allowed");
        update($decision);
end

rule "License Expiration - Active License"
    salience 70
    when
        $request : LicenseRenewalRequest( currentLicense.expired == false )
        $decision : RenewalDecision( decision == DecisionType.APPROVED )
    then
        $decision.addReason("License is currently active - renewal approved");
        update($decision);
end