# External Data Service Usage in Drools Rules\n\nThis document explains how to use the external data service and helper methods in your Drools rules.\n\n## Available Global Variables\n\nThe following global variables are available in all Drools rules:\n\n- `externalDataService`: Direct access to the external data service\n- `dataHelper`: Helper methods for common data access patterns\n\n## Global Variable Declarations\n\nAdd these declarations at the top of your .drl files:\n\n```drools\nglobal com.dmv.service.ExternalDataService externalDataService;\nglobal com.dmv.service.ExternalDataHelper dataHelper;\n```\n\n## Available Data Collections\n\n### States Collection (`states.json`)\nContains state information including DMV-specific data:\n- `code`: Two-letter state code (e.g., \"CA\", \"NY\")\n- `name`: Full state name\n- `region`: Geographic region\n- `population`: State population\n- `capital`: State capital\n- `dmv.renewalFee`: Base renewal fee\n- `dmv.lateFee`: Late renewal penalty\n- `dmv.testRequired`: Whether test is required for renewals\n- `dmv.onlineRenewalAvailable`: Whether online renewal is supported\n\n### License Classes Collection (`license-classes.json`)\nContains license class definitions:\n- `class`: License class code (e.g., \"CLASS_C\", \"MOTORCYCLE\")\n- `name`: Human-readable name\n- `description`: Detailed description\n- `minAge`: Minimum age requirement\n- `validityYears`: License validity period\n- `renewalFee`: Renewal fee amount\n- `testRequirements.written`: Whether written test is required\n- `testRequirements.vision`: Whether vision test is required\n- `testRequirements.driving`: Whether driving test is required\n- `restrictions`: List of license restrictions\n- `vehicleTypes`: List of allowed vehicle types\n\n### Fee Schedules Collection (`fee-schedules.json`)\nContains fee information:\n- `type`: Fee type (\"renewal\", \"late_fee\", \"reinstatement\", \"test_fee\")\n- `category`: Fee category (\"standard\", \"motorcycle\", etc.)\n- `baseAmount`: Base fee amount\n- `description`: Fee description\n- `effectiveDate`: When fee became effective\n- `applicableTo`: List of license classes this fee applies to\n- `modifiers`: Map of modifier names to amounts\n- `conditions`: Additional conditions for fee application\n\n## Helper Methods\n\nThe `dataHelper` global provides convenient methods:\n\n### State Information\n```drools\n// Get state by code\nOptional<Map<String, Object>> state = dataHelper.getStateByCode(\"CA\");\n\n// Check if online renewal is available\nboolean onlineAvailable = dataHelper.isOnlineRenewalAvailable(\"CA\");\n\n// Get late fee for state\ndouble lateFee = dataHelper.getLateFee(\"CA\");\n```\n\n### License Class Information\n```drools\n// Get license class by code\nOptional<Map<String, Object>> licenseClass = dataHelper.getLicenseClassByCode(\"CLASS_C\");\n\n// Check if driving test is required\nboolean testRequired = dataHelper.requiresDrivingTest(\"MOTORCYCLE\");\n\n// Get renewal fee\ndouble renewalFee = dataHelper.getRenewalFee(\"CLASS_C\");\n\n// Get minimum age\nint minAge = dataHelper.getMinimumAge(\"LEARNER_PERMIT\");\n```\n\n### Fee Calculations\n```drools\n// Get fee schedule\nOptional<Map<String, Object>> feeSchedule = dataHelper.getFeeSchedule(\"renewal\", \"standard\");\n\n// Get all renewal fees\nList<Map<String, Object>> renewalFees = dataHelper.getFeeSchedulesByType(\"renewal\");\n\n// Calculate total fee with modifiers\ndouble totalFee = dataHelper.calculateTotalFee(35.0, modifiers, Arrays.asList(\"senior_discount\"));\n```\n\n## Direct Service Usage\n\nFor more complex queries, use the `externalDataService` directly:\n\n```drools\n// Find by key-value pair\nList<Map<String, Object>> results = externalDataService.findByCollectionAndKey(\"states\", \"region\", \"West\");\n\n// Find entries where key exists\nList<Map<String, Object>> withDmvInfo = externalDataService.findByCollectionAndKeyExists(\"states\", \"dmv\");\n\n// Get entire collection\nList<Map<String, Object>> allStates = externalDataService.findByCollection(\"states\");\n```\n\n## Example Rules\n\n### Rule Using State Data\n```drools\nrule \"California Specific Processing\"\nwhen\n    $request : LicenseRenewalRequest(state == \"CA\")\nthen\n    Optional<Map<String, Object>> stateInfo = dataHelper.getStateByCode(\"CA\");\n    if (stateInfo.isPresent()) {\n        Map<String, Object> dmvInfo = (Map<String, Object>) stateInfo.get().get(\"dmv\");\n        boolean onlineAvailable = (Boolean) dmvInfo.get(\"onlineRenewalAvailable\");\n        \n        if (onlineAvailable) {\n            $request.setProcessingMethod(\"ONLINE\");\n        }\n    }\nend\n```\n\n### Rule Using License Class Data\n```drools\nrule \"Motorcycle License Test Requirement\"\nwhen\n    $request : LicenseRenewalRequest(licenseClass == \"MOTORCYCLE\")\nthen\n    if (dataHelper.requiresDrivingTest(\"MOTORCYCLE\")) {\n        $request.setTestRequired(true);\n        $request.addRequirement(\"DRIVING_TEST\");\n    }\nend\n```\n\n### Rule Using Fee Calculation\n```drools\nrule \"Calculate Renewal Fee with Discounts\"\nwhen\n    $request : LicenseRenewalRequest()\n    $person : PersonalInfo(age >= 65)\nthen\n    Optional<Map<String, Object>> feeSchedule = dataHelper.getFeeSchedule(\"renewal\", \"standard\");\n    if (feeSchedule.isPresent()) {\n        Map<String, Object> modifiers = (Map<String, Object>) feeSchedule.get().get(\"modifiers\");\n        double baseAmount = (Double) feeSchedule.get().get(\"baseAmount\");\n        \n        List<String> applicableModifiers = Arrays.asList(\"senior_discount\");\n        double totalFee = dataHelper.calculateTotalFee(baseAmount, modifiers, applicableModifiers);\n        \n        $request.setCalculatedFee(totalFee);\n    }\nend\n```\n\n## Performance Considerations\n\n- Data is cached in multiple layers (memory, network simulation, file storage)\n- First access to data may be slower as caches are populated\n- Subsequent accesses are much faster due to caching\n- Cache is automatically invalidated when JSON files change\n- Use helper methods when possible as they provide optimized access patterns\n\n## Cache Management\n\nThe external data service provides cache management capabilities:\n\n```java\n// Invalidate cache for specific collection\nexternalDataService.invalidateCache(\"states\");\n\n// Invalidate all caches\nexternalDataService.invalidateAllCaches();\n\n// Warm up cache for better performance\nexternalDataService.warmUpCache(\"license-classes\");\n\n// Get cache statistics\nCacheStatistics stats = externalDataService.getCacheStatistics();\n```\n\n## Troubleshooting\n\n1. **Data not found**: Check that the JSON file exists in `src/main/resources/external-data/`\n2. **Cache issues**: Try invalidating the cache or restarting the application\n3. **Performance issues**: Use cache warm-up for frequently accessed collections\n4. **Rule compilation errors**: Ensure global variables are declared at the top of .drl files\n"